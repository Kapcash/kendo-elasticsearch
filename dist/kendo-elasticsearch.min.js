!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("kendo-elasticsearch",[],t):"object"==typeof exports?exports["kendo-elasticsearch"]=t():e["kendo-elasticsearch"]=t()}(this,function(){return function(e){function t(s){if(r[s])return r[s].exports;var n=r[s]={exports:{},id:s,loaded:!1};return e[s].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}var n=function(){function e(e,t){var r=[],s=!0,n=!1,a=void 0;try{for(var o,i=e[Symbol.iterator]();!(s=(o=i.next()).done)&&(r.push(o.value),!t||r.length!==t);s=!0);}catch(l){n=!0,a=l}finally{try{!s&&i["return"]&&i["return"]()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(1),o=s(a),i=r(2),l=s(i),u=r(3),d=s(u),f=r(6),c=s(f),g=r(4),p=s(g),h=r(5),y=s(h),m=r(7),v=s(m),b=kendo.data;b.ElasticSearchDataSource=b.DataSource.extend({init:function(e){if(!e)throw new Error("Options are required to use ElasticSearchDataSource");if(!(e.transport&&e.transport.read&&e.transport.read.url))throw new Error("transport.read.url must be set to use ElasticSearchDataSource");var t=e.transport.read;t.dataType=t.dataType||"json",t.method=t.method||"POST",t.contentType=t.contentType||"application/json";var r=e.schema&&e.schema.model;if(!r)throw new Error("transport.schema.model must be set to use ElasticSearchDataSource");if(r.esMapping)r.fields=r.fields||{},b.ElasticSearchDataSource.kendoFieldsFromESMapping(r.esMapping,r,r.fields);else{if(!r.fields)throw new Error("transport.schema.model.fields/esMapping must be set");v.fill(r.fields,r)}var s=v.nestedFields(r.fields),a=n(s,2),i=a[0],u=a[1];console.log(v),e.transport.parameterMap=function(t){var s=o.prepareParams(t.sort,t.group,t.columns),n={};return t.skip&&(n.from=t.skip),t.take&&(n.size=t.take),e.aggregationsOnly&&(n.from=0,n.size=0),n.sort=o.kendo2es(s,r.fields),n.query={filtered:{filter:c.kendo2es(t.filter||[],r.fields,e)}},n.inner_hits=p.innerHits(i,r.esMappingKey,u,n.sort,n.query.filtered.filter),n._source=Object.keys(r.fields).filter(function(e){return!r.fields[e].esNestedPath&&!r.fields[e].esParentType&&!r.fields[e].esChildType}).map(function(e){return r.fields[e].esName}),n.aggs=d.kendo2es(t.aggregate,r.fields,i,r.esMappingKey,n.query.filtered.filter),l.kendo2es(n.aggs,t.group,r.fields,i,r.esMappingKey,n.query.filtered.filter),JSON.stringify(n)};var f=e.schema;f.parse=function(t){var s=y.fromHits(t.hits.hits,r.fields);t.aggregations&&(t.aggregations.doc_count=t.hits.total);var n=d.es2kendo(t.aggregations),a=l.es2kendo(s,t.aggregations,r.fields,e.aggregationsOnly);return{total:t.hits.total,data:s,aggregates:n,groups:a}},f.aggregates=function(e){return e.aggregates},f.groups=function(e){return e.groups},f.data=f.data||"data",f.total=f.total||"total",f.model.id=f.model.id||"_id",e.serverFiltering=!0,e.serverSorting=!0,e.serverPaging=!0,e.serverAggregates=!0,e.serverGrouping=!0,b.DataSource.fn.init.call(this,e)}}),b.ElasticSearchDataSource.kendoFieldsFromESMapping=v.fromMapping},function(e,t){"use strict";function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t,s){return e.filter(function(e){var r=t[e.field];return!!r&&(r.esNestedPath===s||r.esParentType===s||r.esChildType===s)}).map(function(e){return r({},t[e.field].esFilterName,{order:e.dir,missing:"_last",mode:"asc"===e.dir?"min":"max"})})}function n(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=[];e&&e.constructor===Array?r=e:e&&r.push(e);var s=[];return t.forEach(function(e){var t=r.filter(function(t){return t.field===e.field});t.length?(s.push(t[0]),r.splice(r.indexOf(t[0]),1)):s.push({field:e.field,dir:e.dir||"asc"})}),s=s.concat(r)}Object.defineProperty(t,"__esModule",{value:!0});t.kendo2es=s,t.prepareParams=n},function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(e,t,r,s,n,o){var i=[e],l=null;t.forEach(function(e){var t=r[e.field],u=a(e,r,s,n,o),d={};t.esNestedPath&&0!==t.esNestedPath.indexOf(l)?(d[t.esNestedPath+"_nested"]=d[t.esNestedPath+"_nested"]||{nested:{path:t.esFullNestedPath},aggs:{}},d[t.esNestedPath+"_nested"].aggs[e.field+"_group"]=u.group,d[t.esNestedPath+"_nested"].aggs[e.field+"_missing"]=u.missing):(d[e.field+"_group"]=u.group,d[e.field+"_missing"]=u.missing),i.forEach(function(e){Object.keys(d).forEach(function(t){e[t]=d[t]})}),i=Object.keys(u).map(function(e){return u[e].aggregations}),l=t.esNestedPath})}function a(e,t,r,s,n){var a=t[e.field],o={},i={},l=void 0,u=[];(e.aggregates||[]).forEach(function(t){t.field===e.field&&"string"!==a.type?l=t:u.push(t)}),l?(o[l.aggregate]={field:a.esAggName},l.interval&&(o[l.aggregate].interval=l.interval)):o.terms={field:a.esAggName,size:0},i.missing={field:a.esAggName};var f=d.kendo2es(u,t,r,s,n,a.esNestedPath);return o.aggregations=f,i.aggregations=f,{group:o,missing:i}}function o(e,t){var r=Object.keys(e).filter(function(e){return"_group"===e.substr(e.length-6)}).map(function(r){var s=r.substr(0,r.length-6);return t&&(e[s+"_missing"].doc_count+=t),{group:e[r],missing:e[s+"_missing"],fieldKey:s}});return Object.keys(e).filter(function(e){return"_nested"===e.substr(e.length-7)}).forEach(function(t){var s=e.doc_count-e[t].doc_count;r=r.concat(o(e[t],s))}),r}function i(e,t,r,s){var n=[];if(t){var a=o(t);a.forEach(function(t){var a=[],o=l(t.group,t.missing,t.fieldKey);a=s?o.keys.map(function(e){return o.map[e]}):c.fillInGroups(o,e,r[t.fieldKey]);var u=!1;t.group.buckets&&t.group.buckets[0]&&Object.keys(t.group.buckets[0]).forEach(function(e){"_group"!==e.substr(e.length-6)&&"_nested"!==e.substr(e.length-7)||(u=!0)}),a.forEach(function(e){u&&(e.hasSubgroups=!0,e.items=i(e.items,e.bucket,r,s)),delete e.bucket}),n=n.concat(a)})}return n}function l(e,t,r){var s={},n=[];return e.buckets.forEach(function(e){var t=e.key_as_string||e.key;n.push(t),s[t]={field:r,value:t,hasSubgroups:!1,aggregates:d.es2kendo(e),items:[],bucket:e},s[t].aggregates[r]={count:e.doc_count}}),s[""]={field:r,value:"",hasSubgroups:!1,aggregates:d.es2kendo(t),items:[],bucket:t},s[""].aggregates[r]={count:t.doc_count},{map:s,keys:n}}Object.defineProperty(t,"__esModule",{value:!0}),t.es2kendo=t.kendo2es=void 0;var u=r(3),d=s(u),f=r(5),c=s(f);t.kendo2es=n,t.es2kendo=i},function(e,t,r){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1],r=arguments[2],s=arguments[3],n=arguments[4],a=arguments[5],o={};return e.forEach(function(e){var u=t[e.field],d=u.esNestedPath,f=o;if(a!==d){var c=[];a&&0!==d.indexOf(a)?(o.group_reverse_nested=o.group_reverse_nested||{reverse_nested:{},aggregations:{}},f=o.group_reverse_nested.aggregations):a&&(d=d.substr(a.length+1,d.length)),d.split(".").forEach(function(e){c.push(e);var t=a?a+"."+c.join("."):c.join("."),o=s?s+"."+t:t,l=r[t];l&&(f[t]||(f[t+"_filter_nested"]=f[t+"_filter_nested"]||{nested:{path:o},aggregations:{}},f[t+"_filter_nested"].aggregations[t+"_filter"]=f[t+"_filter_nested"].aggregations[t+"_filter"]||{filter:i.innerHitsFilter(o,null,n),aggregations:{}}),f=f[t+"_filter_nested"].aggregations[t+"_filter"].aggregations)})}f[e.field+"_"+e.aggregate]={},f[e.field+"_"+e.aggregate][l[e.aggregate]]={field:u.esAggName}}),o}function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.keys(e).forEach(function(r){e[r]&&(["count","min","max","average","sum"].forEach(function(s){var n=s.length+1;if(r.substr(r.length-n)==="_"+s){var a=r.substr(0,r.length-n);t[a]=t[a]||{},t[a][s]=e[r].value}}),"_nested"!==r.substr(r.length-7)&&"_filter"!==r.substr(r.length-7)||a(e[r],t))}),t}Object.defineProperty(t,"__esModule",{value:!0}),t.es2kendo=t.kendo2es=void 0;var o=r(4),i=s(o),l=(t.kendo2es=n,t.es2kendo=a,{count:"cardinality",min:"min",max:"max",sum:"sum",average:"avg"})},function(e,t){"use strict";function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t,s,n,o){var i={};return Object.keys(e).forEach(function(s){var l=i,u=[];s.split(".").forEach(function(i){u.push(i);var d=u.join("."),f=t?t+"."+d:d,c=e[d];c&&(l[d]||(l[d]={path:r({},f,{_source:c,size:1e4,sort:n,query:{filtered:{filter:a(f,null,o)}}})}),d!==s&&(l[d].path[f].inner_hits=l[d].path[f].inner_hits||{},l=l[d].path[f].inner_hits))})}),Object.keys(s).forEach(function(e){var t=s[e];i[e]={type:r({},e,{_source:t,size:1e4,sort:n,query:{filtered:{filter:a(null,e,o)}}})}}),i}function n(e,t,r){return r.filter(function(r){return r.bool&&r.bool.must||r.bool&&r.bool.should||r.nested&&r.nested.path===e||r.not&&r.not.nested&&r.not.nested.path===e||r.has_child&&r.has_child.type===t||r.not&&r.not.has_child&&r.not.has_child.type===t||r.has_parent&&r.has_parent.type===t||r.not&&r.not.has_parent&&r.not.has_parent.type===t}).map(function(t){return t.nested?t.nested.filter:t.not&&t.not.nested?{not:t.not.nested.filter}:t.has_child?t.has_child.filter:t.not&&t.not.has_child?{not:t.not.has_child.filter}:t.has_parent?t.has_parent.filter:t.not&&t.not.has_parent?{not:t.not.has_parent.filter}:a(e,t)})}function a(e,t,r){return r=$.extend(!0,{},r),r.bool&&r.bool.must&&(r.bool.must=n(e,t,r.bool.must)),r.bool&&r.bool.should&&(r.bool.should=n(e,t,r.bool.should)),r}Object.defineProperty(t,"__esModule",{value:!0});t.innerHits=s,t.innerHitsFilter=a},function(e,t){"use strict";function r(e,t,r){var s=[];return t.forEach(function(t){var n=e.map[t[r.key]||""];if(!n)for(var a="date"===r.type?new Date(t[r.key]):t[r.key],o=0;o<e.keys.length;o++){var i="date"===r.type?new Date(e.keys[o]):e.keys[o];if(a>=i){var l=e.keys[o+1]&&("date"===r.type?new Date(e.keys[o+1]):e.keys[o+1]);(!l||a<l)&&(n=e.map[e.keys[o]])}}if(!n)throw new Error("No group found, val: "+t[r.key]+" field: "+r.key);n.items.push(t),1===n.items.length&&s.push(n)}),s}function s(e,t){var r=[],n=e[t[0]];return void 0===n?[]:(t.length>1?$.isArray(n)?n.forEach(function(e){r=r.concat(s(e,t.slice(1)))}):r=s(n,t.slice(1)):r=$.isArray(n)?n:[n],r)}function n(e,t,r){var o=[];return e.forEach(function(e){var a=e._source||{},i={};i.id=[e._id],Object.keys(t).filter(function(e){var s=t[e];return void 0===r?!(s.esNestedPath||s.esChildType||s.esParentType):s.esNestedPath===r||s.esChildType===r||s.esParentType===r}).forEach(function(e){var r=t[e],n=s(a,r.esNameSplit);if(r.duration&&!moment)throw new Error("Working on durations requires to load momentjs library");"beforeToday"===r.duration&&(n=n.map(function(e){return moment().startOf("day").diff(moment(e).startOf("day"),"days")})),"afterToday"===r.duration&&(n=n.map(function(e){return moment(e).startOf("day").diff(moment().startOf("day"),"days")})),n&&(r.esMultiSplit?n&&n.length?i[e]=n:i[e]=[null]:i[e]=n.join(r.esMultiSeparator||"\n"))});var l=[i];Object.keys(e.inner_hits||{}).forEach(function(r){var s=n(e.inner_hits[r].hits.hits,t,r),a=[];l.forEach(function(e){s.length?s.forEach(function(t){var r={};Object.keys(t).forEach(function(e){r[e]=t[e]}),Object.keys(e).forEach(function(t){r[t]=e[t]}),a.push(r)}):a.push(e)}),l=a}),o=o.concat(l)}),a(o)}function a(e){var t=[];return e.forEach(function(e){var r=[{}];Object.keys(e).forEach(function(t){var s=[];e[t]&&e[t].constructor===Array?e[t].forEach(function(e){r.forEach(function(r){var n={};Object.keys(r).forEach(function(e){return n[e]=r[e]}),n[t]=e,s.push(n)})}):r.forEach(function(r){r[t]=e[t],s.push(r)}),r=s}),t=t.concat(r)}),t}Object.defineProperty(t,"__esModule",{value:!0});t.fillInGroups=r,t.fromHits=n},function(e,t){"use strict";function r(e,t,n){var a=void 0,o="and";if(e.operator)a=[e];else if(e.logic)o=e.logic,a=e.filters||[];else{if(e.constructor!==Array)throw new Error("Unsupported filter object: "+e);a=e}var i=[],l={},u=void 0;a.forEach(function(e){if(e.logic)i.push(r(e,t));else{var a=t[e.field];if(!a)throw new Error("Unknown field in filter: "+e.field);var d=void 0;try{d={query:{query_string:{query:s(e,t,n),analyze_wildcard:!0}}}}catch(f){if("missing filter is not supported on nested fields"!==f.message)throw f;u={nested:{path:a.esFullNestedPath,filter:{not:{exists:{field:a.esFullNestedPath+"."+a.esName}}}}}}if(a.esNestedPath&&!u){var c=l[a.esNestedPath]||{nested:{path:a.esFullNestedPath,filter:{bool:{}}}};switch(o){case"and":c.nested.filter.bool.must=c.nested.filter.bool.must||[],c.nested.filter.bool.must.push(d);break;case"or":c.nested.filter.bool.should=c.nested.filter.bool.should||[],c.nested.filter.bool.should.push(d)}d=l[a.esNestedPath]?null:l[a.esNestedPath]=c}else a.esParentType?d={has_parent:{type:a.esParentType,filter:d}}:a.esChildType&&(d={has_child:{type:a.esChildType,filter:d}});d&&i.push(d)}});var d={bool:{}};switch(o){case"and":d.bool.must=i;break;case"or":d.bool.should=i}return u&&(d.bool.must_not=[u]),d}function s(e,t,r){e.operator=e.operator||"eq";var s=t[e.field];if(s.duration&&!moment)throw new Error("Working on durations requires to load momentjs library");"beforeToday"===s.duration&&(e.value=moment().startOf("day").subtract(e.value,"days").format(),"lt"===e.operator?e.operator="gt":"lte"===e.operator?e.operator="gte":"gt"===e.operator?e.operator="lt":"gte"===e.operator&&(e.operator="lte")),"afterToday"===s.duration&&(e.value=moment().startOf("day").add(e.value,"days").format());var a=void 0;a="search"===e.operator?s.esSearchName:s.esFilterName;var o=n(a),i=n(e.value,e.operator),l={eq:"",search:"",lt:"<",lte:"<=",gt:">",gte:">="};if(void 0!==l[e.operator]){var u=l[e.operator];return r&&r.missingBooleanAsFalse===!0&&e.value===!1?o+":"+u+i+" OR _missing_:"+o:o+":"+u+i}var d=void 0;switch(e.operator){case"neq":return"NOT ("+o+":"+i+")";case"contains":return"("+o+":*"+i+"*)";case"doesnotcontain":return"NOT ("+o+":*"+i+"*)";case"startswith":return o+":"+i+"*";case"endswith":return o+":*"+i;case"missing":if(s.esNestedPath||s.esParentType||s.esChildType)throw new Error("missing filter is not supported on nested fields");return d="_missing_:"+o,"string"===s.type&&(d+=" OR ("+o+':"")'),d;case"exists":return d="_exists_:"+o,"string"===s.type&&(d+=" AND NOT("+o+':"")'),d;default:throw new Error("Unsupported Kendo filter operator: "+e.operator)}}function n(e,t){return e.constructor===Date?e=e.toISOString():"boolean"!=typeof e&&"number"!=typeof e||(e=""+e),"search"===t?(e=e.replace("\\","\\\\"),(e.match(/"/g)||[]).length%2===1&&(e=e.replace(/"/g,'\\"')),e=e.replace(o,"\\$&")):e.replace("\\","\\\\").replace(a,"\\$&")}Object.defineProperty(t,"__esModule",{value:!0});var a=(t.kendo2es=r,/[+\-&|!()\{}\[\]^:"~*?:\/ ]/g),o=/[+\-&|!()\{}\[\]^:~:\/]/g},function(e,t){"use strict";function r(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",i=arguments[4],l=arguments[5];return Object.keys(e.properties||{}).forEach(function(s){var u=e.properties[s],d=n(s),f=o?o+"_"+d:d,c=i?i+"."+s:s;if("nested"===u.type){var g=l?l+"."+c:c;r(u,t,a,f,"",g)}else if(u.properties)r(u,t,a,f,c,l);else if("object"===u.type);else{var p=a[f]=a[f]||{};p.esNestedPath||(p.type=p.type||u.type,["float","double","integer","long","short","byte"].indexOf(p.type)!==-1&&(p.type="number"),"string"!==p.type&&(p.esMultiSplit=!0),l&&(p.esNestedPath=l),p.esName=c,"not_analyzed"===u.index&&(p.esSearchSubField=null,p.esFilterSubField=null,p.esAggSubField=null))}}),s(a,t),a}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var r in e)if(e.hasOwnProperty(r)){var s=e[r];s.key=r,s.esName=s.esName||r,s.esNameSplit=s.esName.split("."),s.esNestedPath&&(s.esFullNestedPath=s.esNestedPath,t.esMappingKey&&(s.esFullNestedPath=t.esMappingKey+"."+s.esFullNestedPath)),s.esSearchName||(s.esSearchName=s.esName,s.hasOwnProperty("esSearchSubField")?s.esSearchSubField&&(s.esSearchName+="."+s.esSearchSubField):"string"===s.type&&t.esStringSubFields&&t.esStringSubFields.search&&(s.esSearchName+="."+t.esStringSubFields.search),s.esNestedPath&&(s.esSearchName=s.esNestedPath+"."+s.esSearchName)),s.esFilterName||(s.esFilterName=s.esName,s.hasOwnProperty("esFilterSubField")?s.esFilterSubField&&(s.esFilterName+="."+s.esFilterSubField):"string"===s.type&&t.esStringSubFields&&t.esStringSubFields.filter&&(s.esFilterName+="."+t.esStringSubFields.filter),s.esNestedPath&&(s.esFilterName=s.esNestedPath+"."+s.esFilterName)),s.esAggName||(s.esAggName=s.esName,s.hasOwnProperty("esAggSubField")?s.esAggSubField&&(s.esAggName+="."+s.esAggSubField):"string"===s.type&&t.esStringSubFields&&t.esStringSubFields.agg&&(s.esAggName+="."+t.esStringSubFields.agg),s.esNestedPath&&(s.esAggName=s.esFullNestedPath+"."+s.esAggName))}}function n(e){return e.replace(/[^a-zA-z0-9_$]/g,"_")}function a(e){var t={},r={};return Object.keys(e).forEach(function(s){var n=e[s];n.esNestedPath&&(t[n.esNestedPath]=t[n.esNestedPath]||[],t[n.esNestedPath].push(n.esName)),n.esParentType&&(r[n.esParentType]=r[n.esParentType]||[],r[n.esParentType].push(n.esName)),n.esChildType&&(r[n.esChildType]=r[n.esChildType]||[],r[n.esChildType].push(n.esName))}),[t,r]}Object.defineProperty(t,"__esModule",{value:!0});t.fromMapping=r,t.fill=s,t.nestedFields=a}])});
//# sourceMappingURL=kendo-elasticsearch.min.js.map